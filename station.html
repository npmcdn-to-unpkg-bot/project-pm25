<html>
    <head>
        <meta http-equiv="refresh" content="600">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>PM2.5 Station</title>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80038836-2', 'auto');
  ga('send', 'pageview');

</script>        
    </head>
    <body>
      <h1>PM2.5: <span id="latest-pm25"></span>&micro;g/m&sup3;</h1>
      <h2>上次更新於 <time id="latest-time"></time></h2>
      <canvas id="pm25-chart" width="400" height="400"></canvas>

      <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script src="http://momentjs.com/downloads/moment-with-locales.min.js" type="text/javascript"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.0.0/Chart.min.js"></script>
    	<script>
      function getParameterByName(name, url) {
          if (!url) url = window.location.href;
          name = name.replace(/[\[\]]/g, "\\$&");
          var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
              results = regex.exec(url);
          if (!results) return undefined;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      var REFRESH = 60 * 10 * 1000;
      var ISO_FORMAT = 'YYYY-MM-DDTHH:mm:ssZ';
			var uid = getParameterByName('uid');
			var did = getParameterByName('did');
			if (typeof uid !== 'undefined' && uid !== '') {
        ga('set', 'userId', uid); // Set the user ID using signed-in user_id.
			}
			if (typeof did !== 'undefined' && did != '') {
        var api = 'http://nrl.iis.sinica.edu.tw/LASS/history-hourly.php?device_id=' + did;
        $.get(api, function (data) {
          var feeds = $.parseJSON(data)['feeds'];
          var latest = feeds[feeds.length - 1];
          $('#latest-pm25').text(latest['PM2_5']);
          var mom = moment(latest['timestamp'], ISO_FORMAT);
          moment.locale('zh-tw');
          $('#latest-time').text(mom.fromNow());
          moment.locale('en');

          var DRAW_DAQI_LINE = false;
          var draw = Chart.controllers.line.prototype.draw;
          // Extend the draw function to draw:
          //  - additional horizontal line for DAQI level
          //  - gradient color of the chart
          Chart.controllers.line = Chart.controllers.line.extend({
            setDAQIGradient: function() {
              var ctx = this.chart.chart.ctx;
              var yScale = this.chart.scales['y-axis-0'];
              var end = yScale.end;
              var top = yScale.top;
              var bottom = yScale.bottom;
              var gradient = ctx.createLinearGradient(0,bottom,0,top);

              gradient.addColorStop(70 / end,'#c3b3e4');
              gradient.addColorStop(54 / end,'#faafce');
              gradient.addColorStop(36 / end,'#ffde9b');
              gradient.addColorStop(0,'#94dbbb');
              this.chart.config.data.datasets[0].backgroundColor = gradient;
            },
            drawDAQILines: function() {
              if (!DRAW_DAQI_LINE) {
                return;
              }

              function yPosConverter(value) {
                var end = yScale.end;
                var top = yScale.top;
                var bottom = yScale.bottom;
                return (end - value) / end * (bottom - top) + top;
              }
              // draw line
              var ctx = this.chart.chart.ctx;
              var xScale = this.chart.scales['x-axis-0'];
              var yScale = this.chart.scales['y-axis-0'];
              var lines = [
                {
                  value: 71,
                  color: 'purple'
                },
                {
                  value: 54,
                  color: 'red'
                },
                {
                  value: 36,
                  color: 'gold'
                }
              ];

              for (var i = lines.length; --i >= 0;) {
                ctx.beginPath();
                ctx.moveTo(xScale.left, yPosConverter(lines[i].value));
                ctx.lineWidth = 1;
                ctx.strokeStyle = lines[i].color;
                ctx.lineTo(xScale.right, yPosConverter(lines[i].value));
                ctx.stroke();
                ctx.closePath();
              }
            },
            draw: function() {
              this.setDAQIGradient();
              draw.call(this, arguments[0]);
              this.drawDAQILines();
            }
          });

          var config = {
            type: 'line',
            data: {
              datasets: [{
                label: 'PM2.5 (µg/m³)',
                pointBorderColor: '#EEEEEE',
                pointHoverRadius: 8,
                fill: true,
                tension: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              hover: {
                mode: 'label',
                animationDuration: 0
              },
              tooltips: {
                mode: 'label'
              },
              legend: {
                display: false
              },
              elements: {
                line: {
                  borderWidth: 2,
                  borderColor: '#EEEEEE'
                },
                point: {
                  radius: 6,
                  borderWidth: 2
                }
              },
              scaleLabel: {
                fontColor: '#7d7d7d'
              },
              scales: {
                xAxes: [{
                  type: 'time',
                  gridLines: {
                    display: false
                  },
                  scaleLabel: {
                    display: true
                  },
                  time: {
                    round: true,
                    unitStepSize: 60,
                    displayFormats: {
                      'hour': 'MMM D, HH'
                    }
                  }
                } ],
                yAxes: [{
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: 'PM2.5 (μg/m³)'
                  },
                  ticks: {
                    beginAtZero: true,
                    suggestedMax: 100
                  }
                }]
              }
            }
          };

          function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
          }
          function getDAQIColor(index) {
            if (!isNumeric(index) || index < 0) {
              return '#CCCCCC';
            } else if (index <= 35) {
              return '#94dbbb';
            } else if (index <= 53) {
              return '#ffde9b';
            } else if (index <= 70) {
              return '#faafce';
            } else {
              return '#c3b3e4';
            }
          }

          function getDAQIStatus(index) {
            if (!isNumeric(index) || index < 0) {
              return 'invalid';
            } else if (index <= 35) {
              return 'low';
            } else if (index <= 53) {
              return 'moderate';
            } else if (index <= 70) {
              return 'high';
            } else {
              return 'extreme';
            }
          }

          if (new Date().getTime() - new Date(latest['timestamp']).getTime() < REFRESH) {
            new Notification('PM2.5 Level: '+getDAQIStatus(latest['PM2_5']), {body: 'Concentration: '+latest['PM2_5']+'μg/m³', vibrate: true});
          }
          config.data.datasets[0].data = feeds.map(function (d) {
             return {
                x: moment(d['timestamp'], ISO_FORMAT).format('LLL'),
                y: d['PM2_5']
             } 
          });
          config.data.datasets[0].pointBackgroundColor = feeds.map(function (d) {
             return getDAQIColor(d['PM2_5']);
          });
          var ctx = document.getElementById("pm25-chart");
          var pmChart = new Chart(ctx, config);
          setTimeout(pmChart.update.bind(pmChart), 1000);
        });
			} else {
        //No device id
      }
    	</script>
    </body>
</html>
